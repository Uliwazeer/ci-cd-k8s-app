pipeline {
  agent any

  stages {
    stage('Clone Repo') {
      steps {
        echo 'ğŸ“¥ Cloning repository...'
        git 'https://github.com/Uliwazeer/ci-cd-k8s-app.git'
      }
    }

    stage('Install Dependencies') {
      steps {
        dir('app') {
          echo 'ğŸ“¦ Installing dependencies...'
          sh 'npm install'
        }
      }
    }

    stage('Run Tests') {
      steps {
        dir('app') {
          echo 'ğŸ§ª Running tests...'
          sh 'npm test'
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('app') {
          script {
            echo 'ğŸ³ Building Docker image...'
            docker.build('aliwazeer/ci-cd-app', '.')
          }
        }
      }
    }

    stage('Push to DockerHub') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
          script {
            echo 'ğŸ“¤ Pushing Docker image to DockerHub...'
            docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-creds') {
              docker.image('aliwazeer/ci-cd-app').push('latest')
            }
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        echo 'ğŸš€ Deploying to Kubernetes...'
        sh 'kubectl apply -f k8s/deployment.yaml'
        sh 'kubectl apply -f k8s/service.yaml'
        // Prometheus may not be installed yet, so ignore failure temporarily
        sh 'kubectl apply -f k8s/prometheus.yaml || echo "âš ï¸ Failed to apply prometheus.yaml, likely due to missing CRD."'
      }
    }
  }
}
